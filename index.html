<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administración de Causas</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <style>
    :root {
      --bg: #f4f7fa;
      --card: #fff;
      --primary: #007bff; /* Azul primario */
      --secondary: #6c757d; /* Gris secundario */
      --success: #28a745; /* Verde para éxito */
      --danger: #dc3545; /* Rojo para peligro */
      --warning: #ffc107; /* Amarillo para advertencia */
      --info: #17a2b8; /* Azul claro para información */
      --light: #f8f9fa; /* Gris claro */
      --dark: #343a40; /* Gris oscuro */
      --text: #2c3e50;
      --muted: #7f8c8d;
      --radius: 8px;
      --transition: 0.3s;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    * {
      box-sizing: border-box;
      transition: var(--transition);
    }
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text);
      text-align: center;
      padding: 30px;
    }
    
    /* Fondo de pantalla solo para la página de inicio (login/registro) */
    body:has(#login-form-container:not([style*="display: none"])) {
      background-image: url(https://github.com/Defensoria6/sistemacausas/blob/main/d6_wallpaper_v2.png?raw=true);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    
    /* Alternativa para navegadores que no soportan :has() */
    body.login-page {
      background-image: url(https://github.com/Defensoria6/sistemacausas/blob/main/d6_wallpaper_v2.png?raw=true);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    
    main {
      padding: 2rem;
      max-width: 900px;
      margin: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      margin: 1.5rem auto;
      max-width: 900px;
      width: 100%;
      align-items: center;
    }
    
    /* Contenedor de botones para que se muestren en una sola línea */
    .button-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      width: 100%;
    }

    /* Estilo general de los botones */
    .controls button,
    .controls a {
      flex: 0 0 160px; /* Ancho fijo para consistencia */
      height: 44px;
      font-size: 0.95rem;
      border-radius: var(--radius);
      text-align: center;
      white-space: nowrap;
      cursor: pointer;
      border: 1px solid #ccc; /* Borde sutil para botones blancos */
      background-color: white; /* Color de fondo blanco para todos */
      color: black; /* Color del texto negro */
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      padding: 0 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .controls button:hover,
    .controls a:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      background-color: #f0f0f0; /* Fondo gris claro en hover */
    }

    /* Estilos específicos para los botones de cerrar y cancelar */
    #btnLogout, .btn-delete, #btnCancelar {
        background-color: white; /* Fondo blanco */
        color: var(--danger); /* Texto rojo */
        border: 1px solid var(--danger); /* Borde rojo para destacar */
    }
    
    #btnLogout:hover, .btn-delete:hover, #btnCancelar:hover {
        background-color: var(--danger); /* Fondo rojo en hover */
        color: white; /* Texto blanco en hover */
    }

    /* Resto de estilos de botones que no sean "cerrar" o "cancelar" */
    #btnVerListado, #btnNuevoRegistro, #btnBuscar, #btnImprimir, #btnEstadistica, #btnImprimirEstadistica, .btn-siged, #btn-datos-parte {
        background-color: white;
        color: black;
        border: 1px solid #ccc;
    }
    
    #btnVerListado:hover, #btnNuevoRegistro:hover, #btnBuscar:hover, #btnImprimir:hover, #btnEstadistica:hover, #btnImprimirEstadistica:hover, .btn-siged:hover, #btn-datos-parte:hover {
        background-color: #f0f0f0;
        color: black;
    }

    .btn-add {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-add:hover {
      background-color: #218838;
      transform: translateY(-2px);
    }

    td .btn-table-edit,
    td .btn-table-delete {
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 0.9rem;
    }
    td .btn-table-edit {
      color: #007bff;
    }
    td .btn-table-delete {
      color: #dc3545;
    }
    td .btn-table-edit:hover,
    td .btn-table-delete:hover {
        text-decoration: underline;
    }
    form#formCausa {
      display: none;
      position: relative;
      background: var(--card);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin: 2rem auto;
      max-width: 900px;
      width: 90%;
      animation: fadeIn 0.5s ease;
      overflow-wrap: break-word;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
    }
    .field {
      display: flex;
      flex-direction: column;
      word-wrap: break-word;
    }
    label {
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
      color: var(--muted);
      font-weight: 500;
      text-align: left;
    }
    input, select, textarea {
      padding: 0.8rem;
      border: 1px solid #dfe6e9;
      border-radius: var(--radius);
      font-size: 0.95rem;
      word-wrap: break-word;
    }
    select[multiple] {
      height: auto;
      min-height: 100px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .counter {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: right;
    }
    .multiselect-selected {
      font-size: 0.8rem;
      color: var(--primary);
      margin-top: 5px;
      text-align: left;
    }
    h1, h2 {
      color: #87CEEB;
    }
    /* Clase para cambiar color de títulos después del login */
    .logged-in-title {
      color: #00008B !important; /* Azul oscuro */
    }
    #login-form-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 20px auto;
      max-width: 320px;
      text-align: center;
      background: rgba(255, 255, 255, 0.9);
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    #login-form-container input,
    #login-form-container select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border-radius: var(--radius);
      border: 1px solid #ccc;
    }
    #login-form-container .btn-login {
      background-color: #003366;
      color: white;
      border-radius: var(--radius);
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s;
    }
    #login-form-container .btn-login:hover {
      background-color: #0055a5;
    }
    #mensaje {
      margin-top: 10px;
      font-weight: bold;
      min-height: 24px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: var(--radius);
      max-width: 400px;
      margin: 10px auto;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    /* Estilos para los nuevos botones debajo del login */
    .access-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      margin: 1.5rem auto;
      max-width: 400px;
      width: 100%;
    }
    .access-buttons a {
      flex: 1 1 120px; /* Tamaño flexible para los botones */
      height: 38px;
      font-size: 0.9rem;
      border-radius: var(--radius);
      text-align: center;
      white-space: nowrap;
      cursor: pointer;
      border: none;
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #007bff; /* Un color por defecto para los nuevos botones */
      transition: background-color 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .access-buttons a:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }
    .access-buttons a.btn-siged,
    .access-buttons a.btn-arca,
    .access-buttons a.btn-anses,
    .access-buttons a.btn-electoral,
    .access-buttons a.btn-whatsapp { 
      background-color: #4B0082; /* Morado oscuro */
      color: white;
    }
    .access-buttons a.btn-whatsapp:hover,
    .access-buttons a.btn-siged:hover,
    .access-buttons a.btn-arca:hover,
    .access-buttons a.btn-anses:hover,
    .access-buttons a.btn-electoral:hover {
      background-color: #6a1b9a;
    }
    
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
      font-size: 0.85rem;
      table-layout: fixed;
      word-wrap: break-word;
      box-shadow: var(--shadow);
      background-color: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px 12px;
      vertical-align: top;
      max-width: 150px;
      word-wrap: break-word;
      white-space: normal;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    .prioridad-alta { color: #dc3545; font-weight: bold; }
    .prioridad-media { color: #ffc107; font-weight: normal; }
    .prioridad-baja { color: #28a745; font-weight: normal; }
    .prioridad-ninguna { color: #6c757d; font-weight: normal; }
    .vencimiento-alerta { color: #dc3545; font-weight: bold; }
    #main-app-container {
      display: none;
    }
    .required-asterisk {
      color: #dc3545;
      font-weight: bold;
      margin-left: 5px;
      cursor: help;
    }
    #buscadorInput {
      margin: 1rem auto;
      padding: 10px 15px;
      width: 300px;
      font-size: 1rem;
      border-radius: var(--radius);
      border: 1px solid #ccc;
      display: none;
      box-sizing: border-box;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #estadisticaBox {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--card);
      border: 1px solid #ccc;
      padding: 15px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 320px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 0.9rem;
      display: none;
      z-index: 1000;
      text-align: left;
    }
    #estadisticaBox h4 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }
    #estadisticaBox ul {
      padding-left: 20px;
      margin-top: 0;
      margin-bottom: 0.7rem;
    }
    #estadisticaBox button#closeEstadistica {
      background-color: var(--danger);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: var(--radius);
      float: right;
      cursor: pointer;
      font-weight: bold;
    }
    #userInfo {
      margin-top: 10px;
      font-size: 0.95rem;
      font-weight: bold;
      color: var(--primary);
    }
    
    @media (max-width: 700px) {
      .controls {
        flex-direction: column; /* Columna para el contenedor principal de controles */
      }
      .controls button,
      .controls a {
        flex: 1 1 45%;
        max-width: none;
        margin-bottom: 0.5rem;
      }
      .button-row {
        flex-direction: column; /* Columna para los botones en la fila */
      }
      #btnLogout {
        flex: 1 1 100%;
        max-width: none;
      }
      #login-form-container {
        flex-direction: column;
        max-width: 320px;
      }
      #login-form-container input,
      #login-form-container select {
        width: 100%;
      }
      #login-form-container .btn-login {
        width: 100%;
      }
      .access-buttons a {
          flex: 1 1 100px; /* Ajuste para pantallas pequeñas */
      }
    }

    /* Estilos del Chatbot */
    #toggle-chatbot-button {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 1001;
      transition: transform 0.3s ease, background-color 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    #toggle-chatbot-button:hover {
      transform: scale(1.1);
      background-color: #0056b3;
    }
    #chatbot-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--card);
      border: 1px solid #ccc;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 300px;
      height: 400px;
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    #chat-header {
      padding: 10px;
      background: var(--primary);
      color: white;
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      cursor: pointer;
      font-weight: bold;
    }
    #chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      flex-direction: column;
    }
    #chat-input-area {
      padding: 10px;
      display: flex;
      border-top: 1px solid #eee;
    }
    #chat-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      font-size: 0.9rem;
    }
    #chat-send {
      margin-left: 10px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 8px 12px;
      cursor: pointer;
      font-weight: bold;
    }
    #chat-send:hover {
        background-color: #0056b3;
    }
    .message {
      padding: 8px;
      border-radius: 10px;
      margin-bottom: 8px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user-message {
      background-color: #e0f7fa;
      margin-left: auto;
      text-align: right;
    }
    .bot-message {
      background-color: #f1f8e9;
      margin-right: auto;
      text-align: left;
    }
    .typing-indicator {
        font-style: italic;
        color: #7f8c8d;
        font-size: 0.9rem;
    }
  </style>
</head>
<body class="login-page">

  <h1>Administración de Causas</h1>
  <h2>Defensoría Civil y Comercial 6 - Poder Judicial Misiones</h2>

  <div id="login-form-container" aria-label="Formulario de inicio de sesión y registro">
    <input type="text" id="nombre" placeholder="Nombre" aria-label="Nombre" autocomplete="given-name" />
    <input type="text" id="apellido" placeholder="Apellido" aria-label="Apellido" autocomplete="family-name" />
    <input type="email" id="email" placeholder="Email" autocomplete="username" aria-label="Correo electrónico" />
    <input type="password" id="password" placeholder="Contraseña *" title="Únicamente seis caracteres alfanumericos" pattern="[a-zA-Z0-9]{6}" maxlength="6" autocomplete="current-password" aria-label="Contraseña" />
    <select id="rol" aria-label="Seleccionar rol para registro">
      <option value="">Seleccionar rol (solo para registro)</option>
      <option value="Defensor">Defensor</option>
      <option value="Secretario">Secretario</option>
      <option value="Empleado">Empleado</option>
    </select>
    <button class="btn-login" id="btnLogin" aria-label="Iniciar sesión">Iniciar sesión</button>
    <button class="btn-login" id="btnRegister" aria-label="Registrarse">Registrarse</button>
  </div>

  <div class="access-buttons" id="access-buttons-container">
    <a href="https://seti.afip.gob.ar/padron-puc-constancia-internet/ConsultaConstanciaAction.do" target="_blank" class="btn-arca">ARCA</a>
    <a href="https://servicioswww.anses.gob.ar/censite/index.aspx" target="_blank" class="btn-anses">ANSES</a>
    <a href="https://solicitud-informes-cne.pjn.gov.ar/" target="_blank" class="btn-electoral">PJN Cámara Electoral</a>
    <a href="https://web.whatsapp.com/" target="_blank" class="btn-whatsapp">Whatsapp</a>
  </div>
  
  <div id="mensaje" role="alert" aria-live="polite">Inicie sesión para editar o registrar causas.</div>

  <div id="main-app-container" aria-live="polite" aria-label="Aplicación principal de administración">
    <h3 id="panel-titulo"></h3>
    <div id="userInfo" aria-live="polite" aria-atomic="true"></div>

    <div class="controls" role="group" aria-label="Controles principales">
      <div class="button-row">
        <button id="btnVerListado" aria-label="Ver listado de causas">Ver Listado</button>
        <button id="btnNuevoRegistro" aria-label="Nuevo registro de causa">Nuevo Registro</button>
        <a href="https://defensoria6.github.io/datospartes/" target="_blank" class="btn-datos-parte" id="btn-datos-parte" aria-label="Acceder a datos de partes">Datos de Partes</a>
        <button id="btnBuscar" aria-label="Mostrar campo de búsqueda en listado">Buscar</button>
        <button id="btnImprimir" aria-label="Imprimir listado de causas">Imprimir</button>
        <button id="btnEstadistica" aria-label="Mostrar/ocultar estadísticas">Estadística</button>
        <button id="btnImprimirEstadistica" aria-label="Imprimir estadísticas de causas">Imprimir Estadística</button>
      </div>
      <div class="button-row" style="margin-top: 0.75rem;">
        <button id="btnLogout" aria-label="Cerrar sesión" onclick="cerrarSesion()">Cerrar sesión</button>
      </div>
    </div>

    <input type="text" id="buscadorInput" placeholder="Buscar en el listado..." aria-label="Campo de búsqueda en listado" />

    <div id="tablaCausas" style="overflow-x:auto;" aria-live="polite" role="region" aria-label="Listado de causas"></div>

    <main>
      <form id="formCausa" action="#" method="post" aria-label="Formulario para nuevo expediente o edición">
        <h2 id="tituloForm">Nuevo Expediente</h2>
        <div class="grid">
          <div class="field">
            <label for="numCausa">N° Expediente <span class="required-asterisk" title="Obligatorio">*</span></label>
            <input id="numCausa" name="numCausa" required autocomplete="off" />
          </div>
          <div class="field">
            <label for="caratula">Carátula Completa <span class="required-asterisk" title="Obligatorio">*</span></label>
            <textarea id="caratula" name="caratula" required></textarea>
          </div>
          <div class="field">
            <label for="tipoProceso">Tipo de Proceso <span class="required-asterisk" title="Obligatorio">*</span></label>
            <select id="tipoProceso" name="tipoProceso" required>
              <option value="Administrativo">Administrativo</option>              
              <option value="Civil">Civil</option>
              <option value="Penal">Penal</option>
              <option value="Laboral">Laboral</option>
              <option value="Familia">Familia</option>
              <option value="Violencia Familiar">Violencia Familiar</option>
              <option value="Paz">Juzgado de Paz</option>              
            </select>
          </div>
          <div class="field">
            <label for="juzgado">Juzgado <span class="required-asterisk" title="Obligatorio">*</span></label>
            <select id="juzgado" name="juzgado" required></select>
          </div>
          <div class="field">
            <label for="fechaInicio">Fecha de Inicio</label>
            <input type="date" id="fechaInicio" name="fechaInicio" />
          </div>
          <div class="field">
            <label for="fechaPase">Fecha de Pase</label>
            <input type="datetime-local" id="fechaPase" name="fechaPase" />
          </div>
          <div class="field">
            <label for="intervencion">Intervención</label>
            <select id="intervencion" name="intervencion">
              <option>Ministerio Complementario</option>
              <option>Ministerio Principal</option>
              <option>Patrocinante Actor</option>
              <option>Patrocinante Demandado</option>
              <option>Patrocinante Tercero</option>
              <option value="Defensor de Ausente">Defensor de Ausente</option>
              <option value="Defensor Oficial Asesor Letrado">Defensor Oficial Asesor Letrado</option>
            </select>
          </div>
          <div class="field">
            <label for="audiencias">Audiencias señaladas</label>
            <input type="datetime-local" id="audiencias" name="audiencias" />
          </div>
          <div class="field">
            <label for="vencimiento">Vencimiento</label>
            <input type="datetime-local" id="vencimiento" name="vencimiento" />
          </div>
          <div class="field">
            <label for="usuarioAsignado">Usuario Asignado</label>
            <select id="usuarioAsignado" name="usuarioAsignado"></select>
          </div>
          <div class="field">
            <label for="prioridad">Prioridad de Trabajo</label>
            <select id="prioridad" name="prioridad">
              <option>Alta</option>
              <option>Media</option>
              <option>Baja</option>
              <option>Ninguna</option>
            </select>
          </div>
          <div class="field">
            <label for="estado">Estado</label>
            <select id="estado" name="estado">
              <option>Finalizado</option>
              <option>En trámite</option>
              <option>Archivado</option>
              <option>En Alzada</option>              
            </select>
          </div>
          
          <div class="field">
            <label for="recursos">Recursos Interpuestos</label>
            <select id="recursos" name="recursos">
              <option value="">Seleccione un recurso</option>
              <option value="Apelación">Apelación</option>
              <option value="Queja">Queja</option>              
              <option value="Inconstitucionalidad">Inconstitucionalidad</option>
              <option value="Nulidad">Nulidad</option>
              <option value="Reposición">Reposición</option>
              <option value="Aclaratoria">Aclaratoria</option>
              <option value="Recurso Extraordinario">Recurso Extraordinario</option>
              <option value="Recurso de Hecho">Recurso de Hecho</option>
              <option value="Recurso de Inaplicabilidad">Recurso de Inaplicabilidad</option>
            </select>
          </div>

          <div class="field">
            <label for="radicadoAlzada">Radicado en Alzada</label>
            <select id="radicadoAlzada" name="radicadoAlzada">
              <option value="">No aplica</option>
              <option>Cámara de Apelaciones en lo Civil, Comercial,de Familia y Fiscal Tributaria- Sala I- Posadas</option>
              <option>Cámara de Apelaciones en lo Civil, Comercial,de Familia y Fiscal Tributaria- Sala II- Posadas</option>
              <option>Cámara de Apelaciones en lo Civil, Comercial,de Familia y Fiscal Tributaria- Sala III- Posadas</option>
              <option>Cámara de Apelaciones en lo Civil, Comercial,de Familia y Fiscal Tributaria- Sala IV- Posadas</option>
              <option>Cámara de Apelaciones en lo Civil, Comercial,de Familia y Fiscal Tributaria- Sala V- Posadas</option>
              <option>Cámara de Apelaciones en lo Laboral-Sala I- Posadas</option>
              <option>Cámara de Apelaciones en lo Laboral-Sala II- Posadas</option>
              <option>Cámara de Apelaciones en lo Penal y de Menores-Sal I- Posadas</option>
              <option>Cámara de Apelaciones en lo Penal y de Menores-Sal II- Posadas</option>
              <option>Superior Tribunal de Justicia</option>
              <option>Superior Tribunal de Justicia -Secretaria Judicial</option>
            </select>
          </div>

         <div class="field">
            <label for="proteccionPersona">Medidas de Protección de Persona (Selección múltiple)</label>
            <select id="proteccionPersona" name="proteccionPersona" multiple size="4">
              <option value="Medidas Autosatisfactivas">Medidas Autosatisfactivas</option>
              <option value="Prohibición de Acercamiento">Prohibición de Acercamiento</option>
              <option value="Restricción Perimetral">Restricción Perimetral</option>
              <option value="Asistencia Económica">Asistencia Económica</option>
              <option value="Tenencia Precautoria">Tenencia Precautoria</option>
              <option value="Régimen de Visitas">Régimen de Visitas</option>
              <option value="Alimentos Provisionales">Alimentos Provisionales</option>
              <option value="Asistencia Psicológica">Asistencia Psicológica</option>
              <option value="Asistencia Médica">Asistencia Médica</option>
              <option value="Protección Patrimonial">Protección Patrimonial</option>
              <option value="Curatela">Curatela</option>
              <option value="Tutela">Tutela</option>
              <option value="Guarda">Guarda</option>
            </select>
            <div id="proteccionPersona-selected" class="multiselect-selected"></div>
          </div>

          <div class="field">
            <label for="organismos">Organismos Intervinientes (Selección múltiple)</label>
            <select id="organismos" name="organismos" multiple size="4">
              <option value="Ministerio de Desarrollo Social">Ministerio de Desarrollo Social</option>
              <option value="Ministerio de Salud Misiones">Ministerio de Salud Misiones</option>
              <option value="Secretaría de Niñez, Adolescencia y Familia">Secretaría de Niñez, Adolescencia y Familia</option>
              <option value="Centro provincial de prevención y asistencia integral para el control de las adicciones">Centro provincial de prevención y asistencia integral para el control de las adicciones</option>
              <option value="Hospital Escuela de Salud Mental">Hospital Escuela de Salud Mental</option>
              <option value="Centro de Atención Primaria de la Salud (CAPS)">Centro de Atención Primaria de la Salud (CAPS)</option>
              <option value="Defensoría de Niñas, Niños y Adolescentes">Defensoría de Niñas, Niños y Adolescentes</option>
              <option value="Programa Provincial de Asistencia Integral">Programa Provincial de Asistencia Integral</option>
              <option value="Servicio Local de Protección de Derechos">Servicio Local de Protección de Derechos</option>
              <option value="Secretaria de Adulto Mayor">Secretaria de Adulto Mayor</option>
              <option value="ANSeS">ANSeS</option>
              <option value="PAMI">PAMI</option>
              <option value="Programa ProHuerta">Programa ProHuerta</option>
              <option value="IPRODHA Vivienda">IPRODHA Vivienda</option>
              <option value="Municipalidad de Posadas">Municipalidad de Posadas</option>
            </select>
            <div id="organismos-selected" class="multiselect-selected"></div>
          </div>

          <div class="field" style="grid-column: 1/-1">
            <label for="observaciones">Observaciones (máx. 1000 palabras)</label>
            <textarea id="observaciones" name="observaciones"></textarea>
            <div class="counter" id="counter">0/1000</div>
          </div>
        </div>
        <div class="controls" style="margin-top: 2rem">
          <button class="btn-add" type="button" id="btnGuardar">Guardar</button>
          <button class="btn-delete" type="reset" id="btnCancelar">Cancelar</button>
        </div>
      </form>
    </main>
  </div>

  <div id="estadisticaBox" role="region" aria-live="polite" aria-label="Estadísticas de causas">
    <button id="closeEstadistica" title="Cerrar" aria-label="Cerrar estadísticas">X</button>
    <h4>Estadísticas de Causas</h4>
    <div id="estadisticaContenido"></div>
  </div>

  <button id="toggle-chatbot-button" style="position: fixed; bottom: 20px; left: 20px; background: var(--primary); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; z-index: 1001; display: flex; align-items: center; justify-content: center; padding: 0;">
    <span class="material-symbols-outlined">auto_fix</span>
  </button>
  <div id="chatbot-container">
    <div id="chat-header">Chatbot de Análisis</div>
    <div id="chat-body"></div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Pregunta sobre las causas..." />
      <button id="chat-send">Enviar</button>
    </div>
  </div>


<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig={
    apiKey:"AIzaSyBDXZYAxWsvMiMGCrPRp3EBVuU0dzuWF4M",
    authDomain:"sistemadefensoria6.firebaseapp.com",
    projectId:"sistemadefensoria6"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();

  // Elementos
  const emailInput=document.getElementById("email");
  const passwordInput=document.getElementById("password");
  const rolSelect=document.getElementById("rol");
  const nombreInput=document.getElementById("nombre");
  const apellidoInput=document.getElementById("apellido");
  const mensaje=document.getElementById("mensaje");
  const loginFormContainer=document.getElementById("login-form-container");
  const mainAppContainer=document.getElementById("main-app-container");
  const panelTitulo=document.getElementById("panel-titulo");
  const userInfo=document.getElementById("userInfo");

  const btnLogin=document.getElementById("btnLogin");
  const btnRegister=document.getElementById("btnRegister");
  const btnVerListado=document.getElementById("btnVerListado");
  const btnNuevoRegistro=document.getElementById("btnNuevoRegistro");
  const btnGuardar=document.getElementById("btnGuardar");
  const btnCancelar=document.getElementById("btnCancelar");
  const btnBuscar=document.getElementById("btnBuscar");
  const btnImprimir=document.getElementById("btnImprimir");
  const btnEstadistica=document.getElementById("btnEstadistica");
  const btnImprimirEstadistica=document.getElementById("btnImprimirEstadistica");
  const buscadorInput=document.getElementById("buscadorInput");
  const estadisticaBox=document.getElementById("estadisticaBox");
  const estadisticaContenido=document.getElementById("estadisticaContenido");
  const closeEstadistica=document.getElementById("closeEstadistica");

  const selTipo=document.getElementById("tipoProceso");
  const selJuz=document.getElementById("juzgado");
  const selUsu=document.getElementById("usuarioAsignado");
  const tituloForm=document.getElementById("tituloForm");
  const formCausa=document.getElementById("formCausa");
  const tablaCausasDiv=document.getElementById("tablaCausas");
  const proteccionPersonaSelect=document.getElementById("proteccionPersona");
  const organismosSelect=document.getElementById("organismos");
  const proteccionPersonaSelected=document.getElementById("proteccionPersona-selected");
  const organismosSelected=document.getElementById("organismos-selected");

  // Chatbot elements
  const CHATBOT_URL = 'URL_DE_TU_CLOUD_FUNCTION_AQUI'; // Reemplaza esto con la URL de tu Cloud Function
  const chatbotContainer = document.getElementById('chatbot-container');
  const chatHeader = document.getElementById('chat-header');
  const chatBody = document.getElementById('chat-body');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');
  const toggleChatbotButton = document.getElementById('toggle-chatbot-button');
  
  // Nuevo elemento para los botones de acceso
  const accessButtonsContainer = document.getElementById("access-buttons-container");

  // Referencias a títulos para cambio de color
  const h1Title = document.querySelector('h1');
  const h2Subtitle = document.querySelector('h2');

  // Lista actualizada de juzgados del Poder Judicial de Misiones
  const juzgadosPorTipo={
    Administrativo:[
      "CEJUME - Posadas",
      "DEUT Defensorias - Posadas",
      "Legajo Defensoria Civil y Comercial N° 6"
    ],
    Civil:[
      "Juzgado Civil y Comercial N° 1 - Posadas",
      "Juzgado Civil y Comercial N° 2 - Posadas",
      "Juzgado Civil y Comercial N° 3 - Posadas",
      "Juzgado Civil y Comercial N° 4 - Posadas",
      "Juzgado Civil y Comercial N° 5 - Posadas",
      "Juzgado Civil y Comercial N° 6 - Posadas",
      "Juzgado Civil y Comercial N° 7 - Posadas",
      "Juzgado Civil y Comercial N° 8 - Posadas",
      "Juzgado 1 Inst Civil Comercial Laboral Familia y Violencia Fliar- Apostoles"
    ],
    Penal:[
      "Juzgado de Instrucción N° 1 - Posadas",
      "Juzgado de Instrucción N° 2 - Posadas",
      "Juzgado de Instrucción N° 3 - Posadas",
      "Juzgado de Instrucción N° 6 - Posadas",
      "Juzgado de Instrucción N° 7 - Posadas",
      "Tribunal Penal N° 1 - Posadas",
      "Tribunal Penal N° 2 - Posadas",
      "Juzgado Correccional y de Menores N° 1 - Posadas",
      "Juzgado Correccional y de Menores N° 2 - Posadas"
    ],
    Laboral:[
      "Juzgado Laboral N° 1 - Posadas",
      "Juzgado Laboral N° 2 - Posadas",
      "Juzgado Laboral N° 3 - Posadas",
      "Juzgado Laboral N° 4 - Posadas"
    ],
    Familia:[
      "Juzgado de Familia N° 1 - Posadas",
      "Juzgado de Familia N° 2 - Posadas",
      "Juzgado de Familia N° 3 - Posadas",
      "Juzgado de Familia y Violencia Familiar de Garupá",
      "Juzgado 1 Inst Civil Comercial Laboral Familia y Violencia Fliar- Apostoles"
    ],
    "Violencia Familiar":[
      "Juzgado de Violencia Familiar N° 1 - Posadas",
      "Juzgado de Violencia Familiar N° 2 - Posadas",
      "Juzgado de Familia y Violencia Familiar de Garupá",
      "Juzgado 1 Inst Civil Comercial Laboral Familia y Violencia Fliar- Apostoles"
    ],
    "Paz":[
      "Juzgado de Paz Civil Comercial N° 1 - Posadas",
      "Juzgado de Paz Civil Comercial N° 2 - Posadas",
      "Juzgado de Paz Villa Cabello - Posadas",
      "Juzgado de Paz Itaembe Mini - Posadas",
      "Juzgado de Paz Itaembe Guazu- Posadas",
      "Juzgado de Paz - Garupá",
      "Juzgado de Paz - Garupá Fátima",
      "Juzgado de Paz - Profundidad",
      "Juzgado de Paz - Apóstoles",
      "Juzgado de Paz - Azara",
      "Juzgado de Paz - Candelaria",
      "Juzgado de Paz - Fachinal",
      "Juzgado de Paz - Bonpland",
      "Juzgado de Paz - Cerro Cora",
      "Juzgado de Paz - Martires",
      "Juzgado de Paz - Concepción de la Sierra",
      "Juzgado de Paz - Colonia Polana",
      "Juzgado de Paz - Hipolito Yrigoyen",
      "Juzgado de Paz - San Jose",
      "Juzgado de Paz - Loreto",
      "Juzgado de Paz - Santa Ana",
      "Juzgado de Paz - San Ignacio",
      "Juzgado de Paz - Corpus",
      "Juzgado de Paz - Santo Pipó",
      "Juzgado de Paz - San Jose",
      "Juzgado de Paz - San María",
      "Juzgado de Paz - Tres Capones"
    ]
  };

  const usuarios=[
    "Bazante Nadia Romina","Cardozo Maria Raquel","Cedron Noelia Aurora","Corrales Alicia Mariela","Escobar Monica Graciela",
    "Fioravante Romulo","Gonzalez Alberto Misael","Gonzalez Juan Jose","Gudiño Natalia Esther","Magnani Enzo Luciano",
    "Pablos Patricia","Palacios Ana Gabriela","Ramos Marcelo Gustavo","Riveros Patricia Soledad","Sosa Rita Cecilia"
  ];
  let causaEnEdicion=null;

  // Funcionalidad de Enter en campos de login
  function setupEnterKeyHandlers() {
    const loginInputs = [nombreInput, apellidoInput, emailInput, passwordInput, rolSelect];
    loginInputs.forEach(input => {
      input.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          btnLogin.click(); // Activar botón de login por defecto
        }
      });
    });
  }

  // Validación de contraseña
  function validatePassword(password) {
    const alphanumericRegex = /^[a-zA-Z0-9]{6}$/;
    return alphanumericRegex.test(password);
  }

  // Actualizar visualización de selecciones múltiples
  function actualizarSeleccionesMultiples() {
    // Protección Persona
    const proteccionSeleccionada = Array.from(proteccionPersonaSelect.selectedOptions)
      .map(opt => opt.value)
      .join(', ');
    proteccionPersonaSelected.textContent = proteccionSeleccionada || 'Ninguna seleccionada';
    
    // Organismos
    const organismosSeleccionados = Array.from(organismosSelect.selectedOptions)
      .map(opt => opt.value)
      .join(', ');
    organismosSelected.textContent = organismosSeleccionados || 'Ninguna seleccionada';
  }

  function mostrarMensaje(msg, esError=false){
    mensaje.textContent=msg;
    mensaje.style.color=esError?"#dc3545":"#28a745";
  }

  function cerrarSesion(){
    auth.signOut();
    document.body.classList.add('login-page');
    // Restaurar color original de títulos
    h1Title.classList.remove('logged-in-title');
    h2Subtitle.classList.remove('logged-in-title');
  }

  function initForm(){
    selTipo.innerHTML = "";
    selUsu.innerHTML = "";
    Object.keys(juzgadosPorTipo).forEach(tipo=>{
      let opt=document.createElement("option");
      opt.value=tipo;
      opt.textContent=tipo;
      selTipo.appendChild(opt);
    });
    usuarios.forEach(u=>{
      let opt=document.createElement("option");
      opt.value=u;
      opt.textContent=u;
      selUsu.appendChild(opt);
    });
    selTipo.value="Administrativo";
    actualizarJuzgados();
    selUsu.value=usuarios[0];
    document.getElementById("prioridad").value="Alta";
    document.getElementById("estado").value="En trámite";
    document.getElementById("intervencion").value="Ministerio Complementario";
    document.getElementById("counter").textContent="0/1000";
    
    // Limpiar selecciones múltiples
    Array.from(proteccionPersonaSelect.options).forEach(opt => opt.selected = false);
    Array.from(organismosSelect.options).forEach(opt => opt.selected = false);
    actualizarSeleccionesMultiples();
  }

  function actualizarJuzgados(){
    const tipo=selTipo.value;
    const juzgados=juzgadosPorTipo[tipo]||[];
    selJuz.innerHTML="";
    juzgados.forEach(j=>{
      let opt=document.createElement("option");
      opt.value=j;
      opt.textContent=j;
      selJuz.appendChild(opt);
    });
  }

  function contarPalabras(){
    const ta=document.getElementById("observaciones");
    const words=ta.value.trim().split(/\s+/).filter(w=>w);
    if(words.length>1000) ta.value=words.slice(0,1000).join(" ");
    document.getElementById("counter").textContent=`${ta.value.trim().split(/\s+/).filter(w=>w).length}/1000`;
  }

  async function guardarCausa(uid,email){
    const numCausa=document.getElementById("numCausa").value.trim();
    const caratula=document.getElementById("caratula").value.trim();
    const tipoProceso=document.getElementById("tipoProceso").value;
    const juzgado=document.getElementById("juzgado").value;
    const fechaInicio=document.getElementById("fechaInicio").value;
    const fechaPase=document.getElementById("fechaPase").value;
    const intervencion=document.getElementById("intervencion").value;
    const audiencias=document.getElementById("audiencias").value;
    const vencimiento=document.getElementById("vencimiento").value;
    const usuarioAsignado=document.getElementById("usuarioAsignado").value;
    const prioridad=document.getElementById("prioridad").value;
    const estado=document.getElementById("estado").value;
    const recursos=document.getElementById("recursos").value;
    const radicadoAlzada=document.getElementById("radicadoAlzada").value;
    
    // Obtener selecciones múltiples
    const proteccionPersona = Array.from(proteccionPersonaSelect.selectedOptions).map(opt => opt.value).join(', ');
    const organismos = Array.from(organismosSelect.selectedOptions).map(opt => opt.value).join(', ');
    
    const observaciones=document.getElementById("observaciones").value;

    if(!numCausa || !caratula || !tipoProceso || !juzgado){
      alert("Complete los campos obligatorios.");
      return;
    }
    
    const data={
      numCausa,caratula,tipoProceso,juzgado,fechaInicio,fechaPase,intervencion,audiencias,vencimiento,
      usuarioAsignado,prioridad,estado,recursos,radicadoAlzada,proteccionPersona,organismos,observaciones,
      uid,creadorEmail:email
    };
    
    try{
      if(causaEnEdicion){
        await db.collection("causas").doc(causaEnEdicion).update(data);
        alert("Causa actualizada correctamente.");
        causaEnEdicion=null;
        tituloForm.textContent="Nuevo Expediente";
        btnGuardar.textContent="Guardar";
      } else {
        data.fechaCreacion=new Date();
        await db.collection("causas").add(data);
        alert("Causa registrada correctamente.");
      }
      formCausa.reset();
      initForm();
      cargarCausas(uid);
      mostrarListado();
    }catch(e){
      alert("Error guardando causa: "+e.message);
    }
  }

  async function editarCausa(id){
    try{
      const doc=await db.collection("causas").doc(id).get();
      if(!doc.exists){
        alert("La causa no existe.");
        return;
      }
      const c=doc.data();
      causaEnEdicion=doc.id;
      tituloForm.textContent="Editar Expediente";
      btnGuardar.textContent="Actualizar";
      mostrarFormulario();

      document.getElementById("numCausa").value=c.numCausa||"";
      document.getElementById("caratula").value=c.caratula||"";
      document.getElementById("tipoProceso").value=c.tipoProceso||"";
      actualizarJuzgados();
      document.getElementById("juzgado").value=c.juzgado||"";
      document.getElementById("fechaInicio").value=c.fechaInicio||"";
      document.getElementById("fechaPase").value=c.fechaPase||"";
      document.getElementById("intervencion").value=c.intervencion||"Ministerio Complementario";
      document.getElementById("audiencias").value=c.audiencias||"";
      document.getElementById("vencimiento").value=c.vencimiento||"";
      document.getElementById("usuarioAsignado").value=c.usuarioAsignado||"";
      document.getElementById("prioridad").value=c.prioridad||"Alta";
      document.getElementById("estado").value=c.estado||"En trámite";
      document.getElementById("recursos").value=c.recursos||"";
      document.getElementById("radicadoAlzada").value=c.radicadoAlzada||"";
      
      // Establecer selecciones múltiples
      if (c.proteccionPersona) {
        const protecciones = c.proteccionPersona.split(', ').filter(p => p);
        Array.from(proteccionPersonaSelect.options).forEach(opt => {
          opt.selected = protecciones.includes(opt.value);
        });
      }
      
      if (c.organismos) {
        const orgs = c.organismos.split(', ').filter(o => o);
        Array.from(organismosSelect.options).forEach(opt => {
          opt.selected = orgs.includes(opt.value);
        });
      }
      
      document.getElementById("observaciones").value=c.observaciones||"";
      contarPalabras();
      actualizarSeleccionesMultiples();
    }catch(e){
      alert("Error al editar causa: "+e.message);
    }
  }

  async function cargarCausas(uid){
    try{
      const user=auth.currentUser;
      if(!user) return;
      const userDoc=await db.collection("usuarios").doc(user.uid).get();
      if(!userDoc.exists) {
        mostrarMensaje("Usuario sin datos en Firestore.", true);
        return;
      }
      const rol=userDoc.data().rol;
      let snapshot;
      if(rol==="Defensor" || rol==="Secretario"){
        snapshot=await db.collection("causas").orderBy("fechaCreacion","desc").get();
      } else {
        snapshot=await db.collection("causas")
          .where("uid","==",uid)
          .orderBy("fechaCreacion","desc")
          .get();
      }
      renderizarTablaCausas(snapshot,rol,user.uid);
    } catch(e){
      mostrarMensaje("Error cargando causas: "+e.message,true);
    }
  }

  function formatearFecha(fechaStr, soloFecha=false){
    if(!fechaStr) return "";
    const d=new Date(fechaStr);
    if(isNaN(d)) return fechaStr;
    if(soloFecha) return d.toLocaleDateString("es-AR");
    return d.toLocaleString("es-AR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }

  function renderizarTablaCausas(snapshot, rol, uid){
    const isLoggedIn=uid!==null && uid!==undefined;
    let html=`<h4>Listado de causas</h4><table><thead><tr>
      <th>N° Expediente</th><th>Carátula</th><th>Tipo</th><th>Juzgado</th><th>Fecha Inicio</th>
      <th>Fecha Pase</th><th>Intervención</th><th>Audiencias</th><th>Vencimiento</th><th>Usuario Asignado</th>
      <th>Prioridad</th><th>Estado</th><th>Recursos</th><th>Alzada</th><th>Protección</th><th>Organismos</th><th>Observaciones</th><th>Creador</th>${isLoggedIn?"<th>Acción</th>":""}
    </tr></thead><tbody>`;

    if(snapshot.empty){
      html+=`<tr><td colspan="${isLoggedIn?19:18}">No hay causas registradas.</td></tr>`;
    } else {
      snapshot.forEach(doc=>{
        const c=doc.data();
        const puedeEditar=rol==="Defensor"||rol==="Secretario"||(rol==="Empleado"&&c.uid===uid);
        const puedeEliminar=rol==="Defensor";

        let clasePrioridad="prioridad-ninguna";
        if(c.prioridad){
          switch(c.prioridad.toLowerCase()){
            case "alta": clasePrioridad="prioridad-alta"; break;
            case "media": clasePrioridad="prioridad-media"; break;
            case "baja": clasePrioridad="prioridad-baja"; break;
            default: clasePrioridad="prioridad-ninguna";
          }
        }

        let claseVencimiento="";
        if(c.vencimiento){
          const venc=new Date(c.vencimiento);
          const hoy=new Date();
          if(venc<hoy) claseVencimiento="vencimiento-alerta";
        }

        html+=`<tr>
          <td>${c.numCausa||""}</td>
          <td>${c.caratula||""}</td>
          <td>${c.tipoProceso||""}</td>
          <td>${c.juzgado||""}</td>
          <td>${formatearFecha(c.fechaInicio,true)}</td>
          <td>${formatearFecha(c.fechaPase)}</td>
          <td>${c.intervencion||""}</td>
          <td>${formatearFecha(c.audiencias)}</td>
          <td class="${claseVencimiento}">${formatearFecha(c.vencimiento)}</td>
          <td>${c.usuarioAsignado||""}</td>
          <td class="${clasePrioridad}">${c.prioridad||""}</td>
          <td>${c.estado||""}</td>
          <td>${c.recursos||""}</td>
          <td>${c.radicadoAlzada||""}</td>
          <td>${c.proteccionPersona||""}</td>
          <td>${c.organismos||""}</td>
          <td>${c.observaciones||""}</td>
          <td>${c.creadorEmail||""}</td>`;
        
        if(isLoggedIn){
          html+=`<td>`;
          if(puedeEditar) html+=`<button class="btn-table-edit" onclick="editarCausa('${doc.id}')">Editar</button>`;
          if(puedeEliminar) html+=`<button class="btn-table-delete" onclick="eliminarCausa('${doc.id}')">Eliminar</button>`;
          html+=`</td>`;
        }
        html+=`</tr>`;
      });
    }
    html+=`</tbody></table>`;
    tablaCausasDiv.innerHTML=html;
  }

  async function eliminarCausa(id){
    if(!confirm("¿Está seguro de eliminar esta causa?")) return;
    try{
      await db.collection("causas").doc(id).delete();
      alert("Causa eliminada correctamente.");
      cargarCausas(auth.currentUser.uid);
    }catch(e){
      alert("Error eliminando causa: "+e.message);
    }
  }

  function mostrarListado(){
    tablaCausasDiv.style.display="block";
    formCausa.style.display="none";
    buscadorInput.style.display="none";
  }

  function mostrarFormulario(){
    tablaCausasDiv.style.display="none";
    formCausa.style.display="block";
    buscadorInput.style.display="none";
  }

  function mostrarBuscador(){
    buscadorInput.style.display=buscadorInput.style.display==="none"?"block":"none";
  }

  function buscarEnTabla(){
    const termino=buscadorInput.value.toLowerCase();
    const filas=tablaCausasDiv.querySelectorAll("tbody tr");
    filas.forEach(fila=>{
      const texto=fila.textContent.toLowerCase();
      fila.style.display=texto.includes(termino)?"":"none";
    });
  }

  function imprimirListado(){
    const contenido=tablaCausasDiv.innerHTML;
    const ventana=window.open("","_blank");
    ventana.document.write(`
      <html><head><title>Listado de Causas</title>
      <style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #000;padding:4px;font-size:10px;}</style>
      </head><body>${contenido}</body></html>
    `);
    ventana.document.close();
    ventana.print();
  }

  function calcularEstadisticas(){
    const user = auth.currentUser;
    if(!user) return;
    db.collection("usuarios").doc(user.uid).get()
      .then(doc=>{
        if(!doc.exists) return;
        const rol=doc.data().rol;
        let query;
        if(rol === 'Defensor' || rol === 'Secretario'){
          query = db.collection("causas");
        } else {
          query = db.collection("causas").where("uid","==",user.uid);
        }
        query.get().then(snapshot=>{
          const total = snapshot.size;
          const porProceso = {};
          const porJuzgado = {};
          const porUsuarioAsignado = {};
          const porPrioridad = {};
          const porIntervencion = {};
          const porRecursos = {};
          
          // Para vencimientos y audiencias próximas
          const hoy = new Date();
          const unaSemana = new Date(hoy.getTime() + 7 * 24 * 60 * 60 * 1000);
          const vencimientosProximos = [];
          const audienciasProximas = [];
          
          snapshot.forEach(doc=>{
            const c = doc.data();
            
            // Estadísticas básicas
            if(c.tipoProceso) porProceso[c.tipoProceso] = (porProceso[c.tipoProceso]||0)+1;
            if(c.juzgado) porJuzgado[c.juzgado] = (porJuzgado[c.juzgado]||0)+1;
            if(c.usuarioAsignado) porUsuarioAsignado[c.usuarioAsignado] = (porUsuarioAsignado[c.usuarioAsignado]||0)+1;
            if(c.prioridad) porPrioridad[c.prioridad] = (porPrioridad[c.prioridad]||0)+1;
            if(c.intervencion) porIntervencion[c.intervencion] = (porIntervencion[c.intervencion]||0)+1;
            if(c.recursos) porRecursos[c.recursos] = (porRecursos[c.recursos]||0)+1;
            
            // Vencimientos próximos
            if(c.vencimiento) {
              const fechaVenc = new Date(c.vencimiento);
              if(fechaVenc > hoy && fechaVenc < unaSemana) {
                vencimientosProximos.push({
                  numCausa: c.numCausa,
                  fecha: formatearFecha(c.vencimiento),
                  dias: Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24))
                });
              }
            }
            
            // Audiencias próximas
            if(c.audiencias) {
              const fechaAud = new Date(c.audiencias);
              if(fechaAud > hoy && fechaAud < unaSemana) {
                audienciasProximas.push({
                  numCausa: c.numCausa,
                  fecha: formatearFecha(c.audiencias),
                  dias: Math.ceil((fechaAud - hoy) / (1000 * 60 * 60 * 24))
                });
              }
            }
          });

          function mapToHtml(title,obj){
            if(Object.keys(obj).length === 0) return "";
            let html = `<h5>${title}</h5><ul>`;
            for(const [key,val] of Object.entries(obj)) html+=`<li>${key}: ${val}</li>`;
            html+="</ul>";
            return html;
          }
          
          function listarEventosProximos(title, eventos) {
            if(eventos.length === 0) return "";
            let html = `<h5>${title}</h5><ul>`;
            eventos.forEach(e => {
              html += `<li>${e.numCausa}: ${e.fecha} (en ${e.dias} días)</li>`;
            });
            html += "</ul>";
            return html;
          }

          estadisticaContenido.innerHTML = `
            <p><strong>Total de causas:</strong> ${total}</p>
            ${mapToHtml("Por Tipo de Proceso", porProceso)}
            ${mapToHtml("Por Prioridad", porPrioridad)}
            ${mapToHtml("Por Intervención", porIntervencion)}
            ${mapToHtml("Por Recursos", porRecursos)}
            ${mapToHtml("Por Usuario Asignado", porUsuarioAsignado)}
            ${listarEventosProximos("Vencimientos próximos (7 días)", vencimientosProximos)}
            ${listarEventosProximos("Audiencias próximas (7 días)", audienciasProximas)}
          `;
        });
      });
  }

  function imprimirEstadisticas(){
    const contenido=estadisticaContenido.innerHTML;
    const ventana=window.open("","_blank");
    ventana.document.write(`
      <html><head><title>Estadísticas de Causas</title></head>
      <body><h1>Estadísticas de Causas</h1>${contenido}</body></html>
    `);
    ventana.document.close();
    ventana.print();
  }

  // Event Listeners
  btnLogin.addEventListener("click",async()=>{
    const email=emailInput.value.trim();
    const password=passwordInput.value.trim();
    
    if(!email||!password){
      mostrarMensaje("Complete email y contraseña.",true);
      return;
    }

    // Validar contraseña
    if(!validatePassword(password)){
      mostrarMensaje("La contraseña debe tener exactamente 6 caracteres alfanuméricos.",true);
      return;
    }
    
    try{
      await auth.signInWithEmailAndPassword(email,password);
    }catch(e){
      mostrarMensaje("Error de inicio de sesión: "+e.message,true);
    }
  });

  btnRegister.addEventListener("click",async()=>{
    const nombre=nombreInput.value.trim();
    const apellido=apellidoInput.value.trim();
    const email=emailInput.value.trim();
    const password=passwordInput.value.trim();
    const rol=rolSelect.value;
    
    if(!nombre||!apellido||!email||!password||!rol){
      mostrarMensaje("Complete todos los campos para registrarse.",true);
      return;
    }

    // Validar contraseña
    if(!validatePassword(password)){
      mostrarMensaje("La contraseña debe tener exactamente 6 caracteres alfanuméricos.",true);
      return;
    }
    
    try{
      const userCredential=await auth.createUserWithEmailAndPassword(email,password);
      const user=userCredential.user;
      await db.collection("usuarios").doc(user.uid).set({
        nombre,apellido,email,rol,fechaRegistro:new Date()
      });
      mostrarMensaje("Usuario registrado correctamente.",false);
    }catch(e){
      mostrarMensaje("Error de registro: "+e.message,true);
    }
  });

  btnVerListado.addEventListener("click",()=>{
    cargarCausas(auth.currentUser.uid);
    mostrarListado();
  });

  btnNuevoRegistro.addEventListener("click",()=>{
    causaEnEdicion=null;
    tituloForm.textContent="Nuevo Expediente";
    btnGuardar.textContent="Guardar";
    formCausa.reset();
    initForm();
    mostrarFormulario();
  });

  btnGuardar.addEventListener("click",()=>{
    const user=auth.currentUser;
    if(user) guardarCausa(user.uid,user.email);
  });

  btnCancelar.addEventListener("click",()=>{
    causaEnEdicion=null;
    tituloForm.textContent="Nuevo Expediente";
    btnGuardar.textContent="Guardar";
    mostrarListado();
  });

  btnBuscar.addEventListener("click",mostrarBuscador);
  btnImprimir.addEventListener("click",imprimirListado);
  btnEstadistica.addEventListener("click", ()=>{
    if(estadisticaBox.style.display==='block'){
      estadisticaBox.style.display='none';
    } else {
      estadisticaBox.style.display='block';
      calcularEstadisticas();
    }
  });
  btnImprimirEstadistica.addEventListener("click",imprimirEstadisticas);
  closeEstadistica.addEventListener("click",()=>{
    estadisticaBox.style.display="none";
  });

  buscadorInput.addEventListener("input",buscarEnTabla);
  selTipo.addEventListener("change",actualizarJuzgados);
  document.getElementById("observaciones").addEventListener("input",contarPalabras);
  proteccionPersonaSelect.addEventListener("change",actualizarSeleccionesMultiples);
  organismosSelect.addEventListener("change",actualizarSeleccionesMultiples);

  // Funcionalidad del Chatbot
  toggleChatbotButton.addEventListener('click', () => {
      chatbotContainer.style.display = 'flex';
      toggleChatbotButton.style.display = 'none';
  });
  chatHeader.addEventListener('click', () => {
      chatbotContainer.style.display = 'none';
      toggleChatbotButton.style.display = 'block';
  });

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
          sendMessage();
      }
  });

  async function sendMessage() {
      const message = chatInput.value.trim();
      if (message === '') return;
  
      appendMessage('user', message);
      chatInput.value = '';
      
      appendMessage('bot', 'Escribiendo...', true);
      
      try {
          const response = await fetch(CHATBOT_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message })
          });
          const data = await response.json();
          removeTypingIndicator();
          appendMessage('bot', data.text);
      } catch (error) {
          console.error('Error al enviar el mensaje:', error);
          removeTypingIndicator();
          appendMessage('bot', 'Lo siento, no pude procesar tu solicitud.');
      }
  }

  function appendMessage(sender, text, isTyping = false) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender + '-message');
      messageDiv.textContent = text;
      if (isTyping) {
          messageDiv.id = 'typing-indicator';
          messageDiv.classList.add('typing-indicator');
      }
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
  }

  function removeTypingIndicator() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) {
          indicator.remove();
      }
  }

  // Configurar manejadores de Enter
  setupEnterKeyHandlers();

  // Auth state observer
  auth.onAuthStateChanged(async user=>{
    if(user){
      try{
        const userDoc=await db.collection("usuarios").doc(user.uid).get();
        if(userDoc.exists){
          const userData=userDoc.data();
          mostrarMensaje(`Bienvenido, ${userData.nombre} ${userData.apellido} (${userData.rol})`,false);
          panelTitulo.textContent=`Panel de ${userData.rol}`;
          userInfo.textContent=`Usuario: ${userData.nombre} ${userData.apellido} - ${userData.email}`;
          
          loginFormContainer.style.display="none";
          mainAppContainer.style.display="block";
          // Ocultar los botones de acceso al iniciar sesión
          accessButtonsContainer.style.display = "none";
          document.body.classList.remove('login-page');
          
          // Cambiar color de títulos a azul oscuro después del login
          h1Title.classList.add('logged-in-title');
          h2Subtitle.classList.add('logged-in-title');
          
          initForm();
          cargarCausas(user.uid);
          mostrarListado();
        } else {
          mostrarMensaje("Usuario sin datos en Firestore.",true);
        }
      }catch(e){
        mostrarMensaje("Error cargando datos del usuario: "+e.message,true);
      }
    } else {
      loginFormContainer.style.display="flex";
      mainAppContainer.style.display="none";
      // Mostrar los botones de acceso al cerrar sesión
      accessButtonsContainer.style.display = "flex";
      document.body.classList.add('login-page');
      mostrarMensaje("Inicie sesión para editar o registrar causas.",false);
      
      // Restaurar color original de títulos
      h1Title.classList.remove('logged-in-title');
      h2Subtitle.classList.remove('logged-in-title');
    }
  });

  // Inicialización
  document.addEventListener("DOMContentLoaded",()=>{
    mainAppContainer.style.display="none";
    setupEnterKeyHandlers();
  });
</script>
</body>
</html>
