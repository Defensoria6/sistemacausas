<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protección de Personas Adultas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color:  #a3c8ff;
            color: #333;
            padding-top: 80px;
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .main-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
        }

        .section-btn {
            background-color: white;
            border: 2px solid var(--secondary-color);
            color: var(--primary-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            height: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            background-color: var(--secondary-color);
            color: white;
        }

        .section-btn i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }

        .section-btn:hover i {
            color: white;
        }

        .section-btn h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .legal-reference {
            background-color: #e3f2fd;
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--primary-color);
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 0 5px;
        }

        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }

        .organismo-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }

        .add-organismo {
            margin-top: 10px;
            display: none;
        }

        .organismo-info {
            cursor: pointer;
            color: var(--secondary-color);
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            body {
                padding-top: 70px;
            }

            .section-btn {
                margin-bottom: 15px;
            }
        }

        .toast-container {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 1055;
        }

        .toast {
            background-color: var(--primary-color);
            color: white;
        }

        .organismo-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .organismo-item:hover {
            background-color: #f8f9fa;
        }

        .organismo-modal-img {
            height: 80px;
            width: 80px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 2rem;
        }

        .badge-estado {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 12px;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .caso-card {
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s;
        }

        .caso-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .caso-header {
            cursor: pointer;
        }

        .caso-details {
            display: none;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .view-toggle {
            cursor: pointer;
            color: var(--secondary-color);
        }

        .caso-proteccion { border-left-color: #3498db; }
        .caso-capacidad { border-left-color: #2ecc71; }
        .caso-restriccion { border-left-color: #e67e22; }
        .caso-internacion { border-left-color: #e74c3c; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                Protección de Personas Adultas
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://defensorialocal-seis.github.io/policia/"><b>Policia de Misiones-Comisarias</b></a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="toast-container">
            <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Sistema</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>

        <div id="inicio">
            
            <div class="row">
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="section-btn" data-bs-toggle="modal" data-bs-target="#proteccionModal">
                        <i class="fas fa-user-shield"></i>
                        <h3>Protección Adulto Mayor</h3>
                        <p>Registro de casos para protección de adultos mayores</p>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="section-btn" data-bs-toggle="modal" data-bs-target="#capacidadModal">
                        <i class="fas fa-brain"></i>
                        <h3>Determinación de Capacidad</h3>
                        <p>Evaluación de capacidad jurídica</p>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="section-btn" data-bs-toggle="modal" data-bs-target="#restriccionModal">
                        <i class="fas fa-lock"></i>
                        <h3>Restricción de Capacidad</h3>
                        <p>Procesos de restricción de capacidad</p>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="section-btn" data-bs-toggle="modal" data-bs-target="#internacionModal">
                        <i class="fas fa-hospital"></i>
                        <h3>Internación Involuntaria</h3>
                        <p>Art. 42 - Evaluación para internación involuntaria</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="registros">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="section-title mb-0">Listado Completo de Casos</h2>
                <div>
                    <button class="btn btn-outline-secondary me-2" id="toggleView">
                        <i class="fas fa-list me-1"></i> <span id="viewText">Vista Compacta</span>
                    </button>
                    <button class="btn btn-primary" id="btnActualizar">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Casos Registrados</h5>
                    <div class="d-flex">
                        <input type="text" class="form-control form-control-sm me-2" placeholder="Buscar..." id="searchInput">
                        <button class="btn btn-sm btn-primary" id="searchButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="casosContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando casos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="proteccionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Protección de Adultos Mayores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="legal-reference">
                        <h6><i class="fas fa-scale-balanced"></i> Referencia Legal</h6>
                        <p class="mb-0">Ley Provincial XVI - N° 114 (Antes Ley 4532) - Protección Integral de las Personas Adultas Mayores. Ley Nacional 27.360 - Aprobación de la Convención Interamericana sobre la Protección de los Derechos Humanos de las Personas Mayores.</p>
                    </div>

                    <form id="proteccionForm">
                        <input type="hidden" id="proteccionId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre del Adulto Mayor *</label>
                                <input type="text" class="form-control" id="proteccionNombre" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">DNI *</label>
                                <input type="text" class="form-control" id="proteccionDNI" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Edad *</label>
                                <input type="number" class="form-control" id="proteccionEdad" required min="1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="proteccionTelefono">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="proteccionDireccion">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Situación de Vulnerabilidad *</label>
                            <textarea class="form-control" rows="3" id="proteccionSituacion" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Organismos Intervinientes *</label>
                            <select class="form-select organismo-select" id="proteccionOrganismo" required>
                                <option value="">Seleccionar organismo...</option>
                            </select>
                            <div class="add-organismo" id="proteccionAddOrganismo">
                                <input type="text" class="form-control mt-2" id="proteccionNuevoOrganismo" placeholder="Nombre del nuevo organismo">
                                <input type="text" class="form-control mt-2" id="proteccionNuevoContacto" placeholder="Contacto (email/teléfono)">
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="proteccionNuevoOrganismoCheck">
                                <label class="form-check-label" for="proteccionNuevoOrganismoCheck">
                                    Agregar nuevo organismo
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Intervención de la Defensoría *</label>
                            <select class="form-select" id="proteccionIntervencion" required>
                                <option value="">Seleccionar tipo de intervención...</option>
                                <option value="Patrocinante Actora">Patrocinante Actora</option>
                                <option value="Patrocinante Demandada">Patrocinante Demandada</option>
                                <option value="Patrocinante presunto incapaz">Patrocinante presunto incapaz</option>
                                <option value="Ministerio Público del incapaz">Ministerio Público del incapaz</option>
                                <option value="Asistencia Letrada del Incapaz">Asistencia Letrada del Incapaz</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetForm('proteccion')">Cancelar</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="printModal('proteccion')"><i class="fas fa-print me-1"></i> Imprimir</button>
                    <button type="button" class="btn btn-primary" id="saveProteccion">
                        <span id="proteccionSpinner" class="loading-spinner" style="display: none;"></span>
                        <span id="proteccionButtonText">Guardar Registro</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="capacidadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Determinación de Capacidad</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="legal-reference">
                        <h6><i class="fas fa-scale-balanced"></i> Referencia Legal</h6>
                        <p class="mb-0">Código Civil and Comercial de la Nación, Arts. 31 a 42. Ley Nacional 26.657 - Derecho a la Protección de la Salud Mental. Ley Provincial XVI - N° 26 (Antes Ley 4241) - Adhesión a the Ley Nacional de Salud Mental.</p>
                    </div>

                    <form id="capacidadForm">
                        <input type="hidden" id="capacidadId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre de la Persona *</label>
                                <input type="text" class="form-control" id="capacidadNombre" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">DNI *</label>
                                <input type="text" class="form-control" id="capacidadDNI" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Edad *</label>
                                <input type="number" class="form-control" id="capacidadEdad" required min="1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="capacidadTelefono">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Motivo de Evaluación *</label>
                            <textarea class="form-control" rows="3" id="capacidadMotivo" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Organismos Intervinientes *</label>
                            <select class="form-select organismo-select" id="capacidadOrganismo" required>
                                <option value="">Seleccionar organismo...</option>
                            </select>
                            <div class="add-organismo" id="capacidadAddOrganismo">
                                <input type="text" class="form-control mt-2" id="capacidadNuevoOrganismo" placeholder="Nombre del nuevo organismo">
                                <input type="text" class="form-control mt-2" id="capacidadNuevoContacto" placeholder="Contacto (email/teléfono)">
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="capacidadNuevoOrganismoCheck">
                                <label class="form-check-label" for="capacidadNuevoOrganismoCheck">
                                    Agregar nuevo organismo
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Intervención de la Defensoría *</label>
                            <select class="form-select" id="capacidadIntervencion" required>
                                <option value="">Seleccionar tipo de intervención...</option>
                                <option value="Patrocinante Actora">Patrocinante Actora</option>
                                <option value="Patrocinante Demandada">Patrocinante Demandada</option>
                                <option value="Patrocinante presunto incapaz">Patrocinante presunto incapaz</option>
                                <option value="Ministerio Público del incapaz">Ministerio Público del incapaz</option>
                                <option value="Asistencia Letrada del Incapaz">Asistencia Letrada del Incapaz</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetForm('capacidad')">Cancelar</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="printModal('capacidad')"><i class="fas fa-print me-1"></i> Imprimir</button>
                    <button type="button" class="btn btn-primary" id="saveCapacidad">
                        <span id="capacidadSpinner" class="loading-spinner" style="display: none;"></span>
                        <span id="capacidadButtonText">Guardar Registro</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="restriccionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Restricción de Capacidad</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="legal-reference">
                        <h6><i class="fas fa-scale-balanced"></i> Referencia Legal</h6>
                        <p class="mb-0">Código Civil and Comercial de la Nación, Arts. 32, 43 a 61. Proceso de restricción de capacidad e incapacidad con intervención del Ministerio Público. Se debe priorizar sistemas de apoyo que preserven la autonomía de la persona.</p>
                    </div>

                    <form id="restriccionForm">
                        <input type="hidden" id="restriccionId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre de la Persona *</label>
                                <input type="text" class="form-control" id="restriccionNombre" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">DNI *</label>
                                <input type="text" class="form-control" id="restriccionDNI" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Edad *</label>
                                <input type="number" class="form-control" id="restriccionEdad" required min="1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="restriccionTelefono">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Fundamentos de la Restricción *</label>
                            <textarea class="form-control" rows="3" id="restriccionFundamentos" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Organismos Intervinientes *</label>
                            <select class="form-select organismo-select" id="restriccionOrganismo" required>
                                <option value="">Seleccionar organismo...</option>
                            </select>
                            <div class="add-organismo" id="restriccionAddOrganismo">
                                <input type="text" class="form-control mt-2" id="restriccionNuevoOrganismo" placeholder="Nombre del nuevo organismo">
                                <input type="text" class="form-control mt-2" id="restriccionNuevoContacto" placeholder="Contacto (email/teléfono)">
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="restriccionNuevoOrganismoCheck">
                                <label class="form-check-label" for="restriccionNuevoOrganismoCheck">
                                    Agregar nuevo organismo
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Intervención de la Defensoría *</label>
                            <select class="form-select" id="restriccionIntervencion" required>
                                <option value="">Seleccionar tipo de intervención...</option>
                                <option value="Patrocinante Actora">Patrocinante Actora</option>
                                <option value="Patrocinante Demandada">Patrocinante Demandada</option>
                                <option value="Patrocinante presunto incapaz">Patrocinante presunto incapaz</option>
                                <option value="Ministerio Público del incapaz">Ministerio Público del incapaz</option>
                                <option value="Asistencia Letrada del Incapaz">Asistencia Letrada del Incapaz</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetForm('restriccion')">Cancelar</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="printModal('restriccion')"><i class="fas fa-print me-1"></i> Imprimir</button>
                    <button type="button" class="btn btn-primary" id="saveRestriccion">
                        <span id="restriccionSpinner" class="loading-spinner" style="display: none;"></span>
                        <span id="restriccionButtonText">Guardar Registro</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="internacionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Internación Involuntaria - Art. 42</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="legal-reference">
                        <h6><i class="fas fa-scale-balanced"></i> Referencia Legal</h6>
                        <p class="mb-0">Ley Nacional 26.657 - Arts. 20, 21 y 22 sobre Internación Involuntaria. Control judicial obligatorio en un plazo máximo de 5 días. Requisitos: Peligro cierto e inminente para sí o para terceros, and que otras alternativas terapéuticas hayan resultado insuficientes.</p>
                    </div>

                    <form id="internacionForm">
                        <input type="hidden" id="internacionId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre del Paciente *</label>
                                <input type="text" class="form-control" id="internacionNombre" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">DNI *</label>
                                <input type="text" class="form-control" id="internacionDNI" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Edad *</label>
                                <input type="number" class="form-control" id="internacionEdad" required min="1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="internacionTelefono">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Diagnóstico y Justificación *</label>
                            <textarea class="form-control" rows="3" id="internacionDiagnostico" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Organismos Intervinientes *</label>
                            <select class="form-select organismo-select" id="internacionOrganismo" required>
                                <option value="">Seleccionar organismo...</option>
                            </select>
                            <div class="add-organismo" id="internacionAddOrganismo">
                                <input type="text" class="form-control mt-2" id="internacionNuevoOrganismo" placeholder="Nombre del nuevo organismo">
                                <input type="text" class="form-control mt-2" id="internacionNuevoContacto" placeholder="Contacto (email/teléfono)">
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="internacionNuevoOrganismoCheck">
                                <label class="form-check-label" for="internacionNuevoOrganismoCheck">
                                    Agregar nuevo organismo
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Intervención de la Defensoría *</label>
                            <select class="form-select" id="internacionIntervencion" required>
                                <option value="">Seleccionar tipo de intervención...</option>
                                <option value="Patrocinante Actora">Patrocinante Actora</option>
                                <option value="Patrocinante Demandada">Patrocinante Demandada</option>
                                <option value="Patrocinante presunto incapaz">Patrocinante presunto incapaz</option>
                                <option value="Ministerio Público del incapaz">Ministerio Público del incapaz</option>
                                <option value="Asistencia Letrada del Incapaz">Asistencia Letrada del Incapaz</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetForm('internacion')">Cancelar</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="printModal('internacion')"><i class="fas fa-print me-1"></i> Imprimir</button>
                    <button type="button" class="btn btn-primary" id="saveInternacion">
                        <span id="internacionSpinner" class="loading-spinner" style="display: none;"></span>
                        <span id="internacionButtonText">Guardar Registro</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="organismoDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="organismoDetailTitle">Detalles del Organismo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="organismo-modal-img">
                        <i class="fas fa-building"></i>
                    </div>
                    <h4 class="text-center mb-3" id="organismoDetailName"></h4>
                    <div class="organismo-details">
                        <div class="mb-2" id="organismoDetailDireccion"></div>
                        <div class="mb-2" id="organismoDetailEmail"></div>
                        <div class="mb-2" id="organismoDetailTelefono"></div>
                        <div class="mb-2" id="organismoDetailContacto"></div>
                        <div class="mb-2" id="organismoDetailInfo"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEo_AZS9Sx-YwePNNqGwLvsWR9X1nlL5A",
            authDomain: "proteccion-unificada.firebaseapp.com",
            databaseURL: "https://proteccion-unificada-default-rtdb.firebaseio.com",
            projectId: "proteccion-unificada",
            storageBucket: "proteccion-unificada.firebasestorage.app",
            messagingSenderId: "536876739483",
            appId: "1:536876739483:web:6ce9044af245cc116a4f3e"
        };
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // Variables globales
        let organismos = [];
        let registros = [];
        let currentRegistroId = null;
        let isEditing = false;
        let currentEditType = null;
        let compactView = true;
        // Organismos por defecto
        const defaultOrganismos = [
            { nombre: "Hospital Barreyro", email: "hospitaldepediatriabarreyro@gmail.com", tipo: "Hospital de Pediatría" },
            { nombre: "Hospital Carrillo", email: "hospitalsaludmentalcarrillo@gmail.com", tipo: "Hospital de Salud Mental" },
            { nombre: "Ministerio de Salud Pública de Misiones", email: "juridicomspmisiones@gmail.com", tipo: "Oficios dirigidos a cualquier Hospital", contacto: "Jordana Duarte Martinelli - +5493755636878" },
            { nombre: "Unidad Central de Traslado", email: "mps-uct@hotmail.com", tipo: "Servicios de traslado médico" },
            { nombre: "Dirección de Asuntos de Familia", telefono: "+5493764856048", tipo: "Atención en asuntos familiares" },
            { nombre: "Fundación Reto a la Vida", email: "retomisiones@gmail.com", tipo: "Fundación de apoyo social" }
        ];
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        // Función para inicializar la aplicación
        function initApp() {
            // Configurar navegación
            setupNavigation();
            // Configurar eventos de los formularios
            setupFormEvents();
            // Configurar eventos de los checkboxes para nuevos organismos
            setupOrganismoCheckboxes();
            // Cargar organismos
            loadOrganismos();
            // Cargar registros
            loadRegistros();
        }
        // Cargar organismos
        function loadOrganismos() {
            organismos = [...defaultOrganismos];
            populateOrganismosSelects();
        }
        // Llenar los selects de organismos en todos los formularios
        function populateOrganismosSelects() {
            const selects = [
                "proteccionOrganismo",
                "capacidadOrganismo",
                "restriccionOrganismo",
                "internacionOrganismo"
            ];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Seleccionar organismo...</option>';
                    organismos.forEach((org, index) => {
                        const option = document.createElement("option");
                        option.value = index;
                        option.textContent = org.nombre;
                        select.appendChild(option);
                    });
                    const otroOption = document.createElement("option");
                    otroOption.value = "otro";
                    otroOption.textContent = "Otro (especificar)";
                    select.appendChild(otroOption);
                }
            });
        }
        // Configurar la navegación entre secciones
        function setupNavigation() {
            document.getElementById('navInicio')?.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('inicio');
            });
            document.getElementById('btnActualizar').addEventListener('click', loadRegistros);
            document.getElementById('toggleView').addEventListener('click', toggleView);
            document.getElementById('searchInput').addEventListener('input', filterAndDisplayRegistros);
            document.getElementById('searchButton').addEventListener('click', filterAndDisplayRegistros);
        }
        // Mostrar la sección adecuada
        function showSection(sectionId) {
            document.getElementById('inicio').style.display = 'none';
            document.getElementById('registros').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';

            // Actualizar la clase 'active' de la navegación
            document.getElementById('navInicio')?.classList.remove('active');
            document.getElementById('navRegistros')?.classList.remove('active');
            if (sectionId === 'inicio') {
                document.getElementById('navInicio')?.classList.add('active');
            } else {
                document.getElementById('navRegistros')?.classList.add('active');
            }
        }
        // Configurar los eventos de los formularios
        function setupFormEvents() {
            document.getElementById('saveProteccion').addEventListener('click', () => saveRegistro('proteccion'));
            document.getElementById('saveCapacidad').addEventListener('click', () => saveRegistro('capacidad'));
            document.getElementById('saveRestriccion').addEventListener('click', () => saveRegistro('restriccion'));
            document.getElementById('saveInternacion').addEventListener('click', () => saveRegistro('internacion'));

            // Eventos para limpiar el formulario cuando se cierra el modal
            document.getElementById('proteccionModal').addEventListener('hidden.bs.modal', () => resetForm('proteccion'));
            document.getElementById('capacidadModal').addEventListener('hidden.bs.modal', () => resetForm('capacidad'));
            document.getElementById('restriccionModal').addEventListener('hidden.bs.modal', () => resetForm('restriccion'));
            document.getElementById('internacionModal').addEventListener('hidden.bs.modal', () => resetForm('internacion'));
        }
        // Configurar checkboxes para agregar nuevos organismos
        function setupOrganismoCheckboxes() {
            const checkboxes = [
                { checkId: 'proteccionNuevoOrganismoCheck', addId: 'proteccionAddOrganismo', selectId: 'proteccionOrganismo' },
                { checkId: 'capacidadNuevoOrganismoCheck', addId: 'capacidadAddOrganismo', selectId: 'capacidadOrganismo' },
                { checkId: 'restriccionNuevoOrganismoCheck', addId: 'restriccionAddOrganismo', selectId: 'restriccionOrganismo' },
                { checkId: 'internacionNuevoOrganismoCheck', addId: 'internacionAddOrganismo', selectId: 'internacionOrganismo' }
            ];

            checkboxes.forEach(item => {
                const checkbox = document.getElementById(item.checkId);
                const addDiv = document.getElementById(item.addId);
                const select = document.getElementById(item.selectId);
                if (checkbox) {
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            addDiv.style.display = 'block';
                            select.disabled = true;
                            select.required = false;
                        } else {
                            addDiv.style.display = 'none';
                            select.disabled = false;
                            select.required = true;
                        }
                    });
                }
            });
        }
        // Función para guardar un registro
        function saveRegistro(tipo) {
            const form = document.getElementById(`${tipo}Form`);
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            const spinnerId = `${tipo}Spinner`;
            const buttonTextId = `${tipo}ButtonText`;
            const saveButton = document.getElementById(`save${capitalizeFirstLetter(tipo)}`);

            // Mostrar spinner y deshabilitar botón
            document.getElementById(spinnerId).style.display = 'inline-block';
            document.getElementById(buttonTextId).textContent = 'Guardando...';
            saveButton.disabled = true;

            const nombre = getVal(`${tipo}Nombre`);
            const dni = getVal(`${tipo}DNI`);
            const edad = getVal(`${tipo}Edad`);
            const telefono = getVal(`${tipo}Telefono`);
            const direccion = getVal(`${tipo}Direccion`) || '';
            const descripcion = getVal(`${tipo}Situacion`) || getVal(`${tipo}Motivo`) || getVal(`${tipo}Fundamentos`) || getVal(`${tipo}Diagnostico`);
            const intervencion = getVal(`${tipo}Intervencion`);

            let organismoNombre = '';
            let organismoContacto = '';

            if (document.getElementById(`${tipo}NuevoOrganismoCheck`)?.checked) {
                organismoNombre = getVal(`${tipo}NuevoOrganismo`);
                organismoContacto = getVal(`${tipo}NuevoContacto`);

                // Guardar el nuevo organismo en la lista
                if (organismoNombre) {
                    const nuevoOrganismo = {
                        nombre: organismoNombre,
                        contacto: organismoContacto,
                        tipo: "Otro"
                    };
                    organismos.push(nuevoOrganismo);
                    populateOrganismosSelects(); // Volver a llenar los selects
                }
            } else {
                const sel = document.getElementById(`${tipo}Organismo`);
                const idx = sel ? sel.value : '';
                if (idx !== '' && idx !== 'otro' && organismos[idx]) {
                    organismoNombre = organismos[idx].nombre || '';
                    organismoContacto = organismos[idx].email || organismos[idx].telefono || organismos[idx].contacto || '';
                }
            }

            const nuevoRegistro = {
                tipo: getTipoNombre(tipo),
                nombre,
                dni,
                edad,
                telefono,
                direccion,
                descripcion,
                intervencion,
                organismo: { nombre: organismoNombre, contacto: organismoContacto },
                fecha: new Date().toISOString(),
                estado: 'Abierto'
            };

            const id = getVal(`${tipo}Id`);

            if (isEditing && id) {
                database.ref('registros/' + id).set(nuevoRegistro)
                .then(() => {
                    showToast('Registro actualizado exitosamente.');
                    resetForm(tipo);
                    loadRegistros();
                })
                .catch(error => {
                    console.error("Error al actualizar:", error);
                    showToast('Error al actualizar el registro.');
                })
                .finally(() => {
                    document.getElementById(spinnerId).style.display = 'none';
                    document.getElementById(buttonTextId).textContent = 'Guardar Registro';
                    saveButton.disabled = false;
                });
            } else {
                const newRegistroRef = database.ref('registros').push();
                newRegistroRef.set(nuevoRegistro)
                .then(() => {
                    showToast('Registro guardado exitosamente.');
                    resetForm(tipo);
                    loadRegistros();
                })
                .catch(error => {
                    console.error("Error al guardar:", error);
                    showToast('Error al guardar el registro.');
                })
                .finally(() => {
                    document.getElementById(spinnerId).style.display = 'none';
                    document.getElementById(buttonTextId).textContent = 'Guardar Registro';
                    saveButton.disabled = false;
                });
            }
        }

        function resetForm(tipo) {
            document.getElementById(`${tipo}Form`).reset();

            const modalElement = document.getElementById(`${tipo}Modal`);
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }

            const addDiv = document.getElementById(`${tipo}AddOrganismo`);
            const select = document.getElementById(`${tipo}Organismo`);
            const checkbox = document.getElementById(`${tipo}NuevoOrganismoCheck`);

            if (addDiv && select && checkbox) {
                checkbox.checked = false;
                addDiv.style.display = 'none';
                select.disabled = false;
                select.required = true;
            }
            
            document.getElementById(`${tipo}Id`).value = '';
            isEditing = false;
            currentEditType = null;
            document.getElementById(`${tipo}ButtonText`).textContent = 'Guardar Registro';
        }

        function getVal(id) {
            const element = document.getElementById(id);
            return element ? element.value : '';
        }

        function getTipoNombre(tipo) {
            switch(tipo) {
                case 'proteccion': return 'Protección Adulto Mayor';
                case 'capacidad': return 'Determinación de Capacidad';
                case 'restriccion': return 'Restricción de Capacidad';
                case 'internacion': return 'Internación Involuntaria';
                default: return tipo;
            }
        }

        function getTipoClass(tipo) {
            const classes = {
                'Protección Adulto Mayor': 'proteccion',
                'Determinación de Capacidad': 'capacidad',
                'Restricción de Capacidad': 'restriccion',
                'Internación Involuntaria': 'internacion'
            };
            return classes[tipo] || '';
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function showToast(message) {
            const toast = new bootstrap.Toast(document.getElementById('liveToast'));
            document.getElementById('toastMessage').textContent = message;
            toast.show();
        }

        // Cargar registros desde Firebase
        function loadRegistros() {
            const casosContainer = document.getElementById('casosContainer');
            if (casosContainer) {
                casosContainer.innerHTML = `<div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            <p class="mt-2">Cargando casos...</p>
                                        </div>`;
            }

            database.ref('registros').on('value', (snapshot) => {
                const data = snapshot.val();
                registros = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                filterAndDisplayRegistros();
            });
        }

        function filterAndDisplayRegistros() {
            const searchValue = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const filteredRegistros = registros.filter(reg =>
                reg.nombre?.toLowerCase().includes(searchValue) ||
                reg.dni?.toLowerCase().includes(searchValue) ||
                reg.tipo?.toLowerCase().includes(searchValue)
            );
            displayRegistros(filteredRegistros);
        }

        // Mostrar los registros en la vista de lista o compacta
        function displayRegistros(list) {
            const casosContainer = document.getElementById('casosContainer');
            if (!casosContainer) return;

            casosContainer.innerHTML = '';

            if (list.length === 0) {
                casosContainer.innerHTML = `<div class="alert alert-info text-center mt-3">No hay casos registrados que coincidan con la búsqueda.</div>`;
                return;
            }

            list.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)); // Ordenar por fecha descendente

            list.forEach(registro => {
                const card = document.createElement('div');
                card.classList.add('card', 'mb-3', 'caso-card', `caso-${getTipoClass(registro.tipo)}`);

                let estadoBadgeClass = 'bg-secondary';
                if (registro.estado === 'Abierto') estadoBadgeClass = 'bg-success';
                if (registro.estado === 'En Proceso') estadoBadgeClass = 'bg-warning text-dark';
                if (registro.estado === 'Cerrado') estadoBadgeClass = 'bg-danger';

                if (compactView) {
                    card.innerHTML = `
                        <div class="card-body p-3 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${registro.nombre} <small class="text-muted">(${registro.dni})</small></h6>
                                <p class="mb-0 text-muted" style="font-size: 0.9rem;">${registro.tipo}</p>
                            </div>
                            <div>
                                <span class="badge ${estadoBadgeClass}">${registro.estado}</span>
                                <button class="btn btn-sm btn-outline-info ms-2" onclick="editRegistro('${registro.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRegistro('${registro.id}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center caso-header" onclick="toggleDetails(this)">
                                <h5 class="mb-0">${registro.nombre} <small class="text-muted">(${registro.dni})</small></h5>
                                <div>
                                    <span class="badge ${estadoBadgeClass}">${registro.estado}</span>
                                    <i class="fas fa-chevron-down ms-2"></i>
                                </div>
                            </div>
                            <div class="caso-details mt-3 p-3">
                                <p><strong>Tipo de Caso:</strong> ${registro.tipo}</p>
                                <p><strong>Edad:</strong> ${registro.edad}</p>
                                <p><strong>Teléfono:</strong> ${registro.telefono || 'No especificado'}</p>
                                <p><strong>Dirección:</strong> ${registro.direccion || 'No especificado'}</p>
                                <p><strong>Descripción:</strong> ${registro.descripcion}</p>
                                <p><strong>Intervención:</strong> ${registro.intervencion}</p>
                                <p><strong>Organismo Interviniente:</strong> ${registro.organismo?.nombre || 'No especificado'} (${registro.organismo?.contacto || 'Sin contacto'})</p>
                                <p><strong>Fecha de Registro:</strong> ${new Date(registro.fecha).toLocaleString()}</p>
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-primary" onclick="editRegistro('${registro.id}')">
                                        <i class="fas fa-edit me-1"></i> Editar
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteRegistro('${registro.id}')">
                                        <i class="fas fa-trash-alt me-1"></i> Eliminar
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="printRegistro('${registro.id}')">
                                        <i class="fas fa-print me-1"></i> Imprimir
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                casosContainer.appendChild(card);
            });
        }

        function toggleDetails(element) {
            const details = element.closest('.card-body').querySelector('.caso-details');
            const icon = element.querySelector('.fas');

            if (details.style.display === 'block') {
                details.style.display = 'none';
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            } else {
                details.style.display = 'block';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            }
        }

        function toggleView() {
            compactView = !compactView;
            document.getElementById('viewText').textContent = compactView ? 'Vista Extendida' : 'Vista Compacta';
            filterAndDisplayRegistros();
        }

        function editRegistro(id) {
            isEditing = true;
            currentRegistroId = id;
            const registro = registros.find(r => r.id === id);
            
            if (!registro) {
                showToast('Registro no encontrado.');
                return;
            }

            const tipo = getTipoClass(registro.tipo);
            currentEditType = tipo;
            const modalElement = document.getElementById(`${tipo}Modal`);
            const modalInstance = new bootstrap.Modal(modalElement);
            
            // Llenar campos del formulario
            document.getElementById(`${tipo}Id`).value = registro.id;
            document.getElementById(`${tipo}Nombre`).value = registro.nombre;
            document.getElementById(`${tipo}DNI`).value = registro.dni;
            document.getElementById(`${tipo}Edad`).value = registro.edad;
            document.getElementById(`${tipo}Telefono`).value = registro.telefono;
            if (tipo === 'proteccion') {
                document.getElementById(`${tipo}Direccion`).value = registro.direccion;
            }
            const descripcionId = tipo === 'proteccion' ? 'proteccionSituacion' :
                                  tipo === 'capacidad' ? 'capacidadMotivo' :
                                  tipo === 'restriccion' ? 'restriccionFundamentos' : 'internacionDiagnostico';
            document.getElementById(descripcionId).value = registro.descripcion;
            document.getElementById(`${tipo}Intervencion`).value = registro.intervencion;
            
            // Lógica para el organismo interviniente
            const selectOrganismo = document.getElementById(`${tipo}Organismo`);
            const organismoIndex = organismos.findIndex(org => org.nombre === registro.organismo.nombre);
            const checkbox = document.getElementById(`${tipo}NuevoOrganismoCheck`);
            const addDiv = document.getElementById(`${tipo}AddOrganismo`);

            if (organismoIndex !== -1) {
                selectOrganismo.value = organismoIndex;
                checkbox.checked = false;
                addDiv.style.display = 'none';
                selectOrganismo.disabled = false;
                selectOrganismo.required = true;
            } else {
                checkbox.checked = true;
                addDiv.style.display = 'block';
                document.getElementById(`${tipo}NuevoOrganismo`).value = registro.organismo.nombre;
                document.getElementById(`${tipo}NuevoContacto`).value = registro.organismo.contacto;
                selectOrganismo.disabled = true;
                selectOrganismo.required = false;
            }
            
            document.getElementById(`${tipo}ButtonText`).textContent = 'Actualizar Registro';
            modalInstance.show();
        }

        function deleteRegistro(id) {
            if (confirm("¿Estás seguro que deseas eliminar este registro? Esta acción es irreversible.")) {
                database.ref('registros/' + id).remove()
                .then(() => {
                    showToast('Registro eliminado exitosamente.');
                })
                .catch(error => {
                    console.error("Error al eliminar:", error);
                    showToast('Error al eliminar el registro.');
                });
            }
        }

        function printRegistro(id) {
            const registro = registros.find(r => r.id === id);
            if (registro) {
                const html = buildRegistroPrintable(registro);
                printHTMLContent(html);
            } else {
                showToast('Registro no encontrado para imprimir.');
            }
        }

        // Modal para mostrar detalles de organismo
        function showOrganismoDetail(index) {
            const organismo = organismos[index];
            if (organismo) {
                document.getElementById('organismoDetailName').textContent = organismo.nombre;
                document.getElementById('organismoDetailEmail').textContent = `Email: ${organismo.email || 'No disponible'}`;
                document.getElementById('organismoDetailTelefono').textContent = `Teléfono: ${organismo.telefono || 'No disponible'}`;
                document.getElementById('organismoDetailContacto').textContent = `Contacto: ${organismo.contacto || 'No disponible'}`;
                document.getElementById('organismoDetailDireccion').textContent = `Dirección: ${organismo.direccion || 'No disponible'}`;
                document.getElementById('organismoDetailInfo').textContent = `Tipo: ${organismo.tipo || 'No especificado'}`;

                const modalElement = document.getElementById('organismoDetailModal');
                const modalInstance = new bootstrap.Modal(modalElement);
                modalInstance.show();
            }
        }

        // ====== Funciones de impresión ======
        function buildRegistroPrintable(registro) {
            const html = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <title>Registro de Caso - Imprimir</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 20px; color: #333; }
                        .print-container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
                        h1 { color: #2c3e50; text-align: center; }
                        h3 { margin-top: 20px; padding-bottom: 5px; border-bottom: 2px solid #3498db; }
                        p { margin-bottom: 10px; line-height: 1.6; }
                        .info-box { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
                        strong { color: #555; }
                        .footer { margin-top: 30px; font-size: 0.9em; text-align: center; color: #777; }
                    </style>
                </head>
                <body>
                    <div class="print-container">
                        <h1>Registro de Caso: ${registro.tipo}</h1>
                        <p><strong>Fecha de Registro:</strong> ${new Date(registro.fecha).toLocaleString()}</p>

                        <h3>Datos de la Persona</h3>
                        <div class="info-box">
                            <p><strong>Nombre:</strong> ${registro.nombre}</p>
                            <p><strong>DNI:</strong> ${registro.dni}</p>
                            <p><strong>Edad:</strong> ${registro.edad}</p>
                            <p><strong>Teléfono:</strong> ${registro.telefono || 'No especificado'}</p>
                            <p><strong>Dirección:</strong> ${registro.direccion || 'No especificado'}</p>
                        </div>

                        <h3>Detalles del Caso</h3>
                        <div class="info-box">
                            <p><strong>Descripción/Justificación:</strong> ${registro.descripcion}</p>
                            <p><strong>Intervención de la Defensoría:</strong> ${registro.intervencion}</p>
                            <p><strong>Organismo Interviniente:</strong> ${registro.organismo?.nombre || 'No especificado'} (${registro.organismo?.contacto || 'Sin contacto'})</p>
                        </div>

                        <div class="footer">
                            <p>Generado por el Sistema Unificado de Protección de Personas.</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            return html;
        }

        function printModal(tipo) {
            const nombre = getVal(`${tipo}Nombre`);
            const dni = getVal(`${tipo}DNI`);
            const edad = getVal(`${tipo}Edad`);
            const telefono = getVal(`${tipo}Telefono`);
            const direccion = tipo === 'proteccion' ? getVal('proteccionDireccion') : '';
            const descripcion = tipo === 'proteccion'
                ? getVal('proteccionSituacion')
                : tipo === 'capacidad'
                ? getVal('capacidadMotivo')
                : tipo === 'restriccion'
                ? getVal('restriccionFundamentos')
                : getVal('internacionDiagnostico');
            const intervencion = getVal(`${tipo}Intervencion`);

            let organismoNombre = '';
            let organismoContacto = '';

            if (document.getElementById(`${tipo}NuevoOrganismoCheck`)?.checked) {
                organismoNombre = getVal(`${tipo}NuevoOrganismo`);
                organismoContacto = getVal(`${tipo}NuevoContacto`);
            } else {
                const sel = document.getElementById(`${tipo}Organismo`);
                const idx = sel ? sel.value : '';
                if (idx !== '' && idx !== 'otro' && organismos[idx]) {
                    organismoNombre = organismos[idx].nombre || '';
                    organismoContacto = organismos[idx].email || organismos[idx].telefono || organismos[idx].contacto || '';
                }
            }

            const registroTmp = {
                tipo: getTipoNombre(tipo),
                nombre, dni, edad: edad ? parseInt(edad) : '',
                telefono, direccion, descripcion, intervencion,
                organismo: { nombre: organismoNombre, contacto: organismoContacto },
                fecha: new Date().toISOString(),
                estado: '—'
            };

            const html = buildRegistroPrintable(registroTmp);
            printHTMLContent(html);
        }

        function printHTMLContent(html) {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }
        // ====== Fin funciones de impresión ======
    </script>
</body>
</html>
